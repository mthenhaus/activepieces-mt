import {
  createPayload
} from "./chunk-LOUXPEJW.mjs";
import {
  createMimeMessage
} from "./chunk-QJ4Z43TQ.mjs";

// src/sending/mail/payloads.ts
async function createMailPayloads(senderMessagingKey, resolvedAddresses, mailData, payloadPluginHeaders) {
  const message = await createMimeMessage(mailData, resolvedAddresses);
  const original = await createPayload(
    senderMessagingKey,
    Buffer.from(message.original),
    "message/x.mailchain",
    payloadPluginHeaders
  );
  const visibleRecipientsPayload = await createPayload(
    senderMessagingKey,
    Buffer.from(message.visibleRecipients),
    "message/x.mailchain",
    payloadPluginHeaders
  );
  const blindRecipients = await Promise.all(
    message.blindRecipients.map(async ({ recipient, content }) => ({
      recipients: [recipient.address],
      payload: await createPayload(
        senderMessagingKey,
        Buffer.from(content),
        "message/x.mailchain",
        payloadPluginHeaders
      )
    }))
  );
  return {
    original,
    distributions: [
      {
        recipients: [
          ...mailData.recipients.map((x) => x.address),
          ...mailData.carbonCopyRecipients.map((x) => x.address)
        ],
        payload: visibleRecipientsPayload
      },
      ...blindRecipients
    ]
  };
}

export {
  createMailPayloads
};
